name: 'Create Pull Request'

description: 'Create PR with dependency updates'

inputs:
  token:
    required: true
    type: string
    description: 'GitHub token'

  base-branch:
    required: true
    type: string
    description: 'Base branch for PR'

  branch-prefix:
    required: true
    type: string
    description: 'Prefix for new branch'

  branch-postfix:
    required: false
    type: string
    description: 'Postfix for new branch, defaults to a unique string on each run to avoid overwrites of existing branches'
    default: ''

  files:
    required: true
    type: string
    description: 'Files to commit'

  commit-message:
    required: true
    type: string
    description: 'Message the commit will have'

  pr-title:
    required: true
    type: string
    description: 'Title of the pull request'

  pr-body:
    required: true
    type: string
    description: 'The Markdown-supported body for the Github pull request'

outputs:
  pr_number:
    description: 'Number of the created pull request'
    value: ${{ steps.create_pr.outputs.pr_number }}

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        if [ -z "${{ inputs.files }}" ] || [ "${{ inputs.files }}" = "" ]; then
          echo "::error::The 'files' input cannot be empty. It represents files to add with 'git add'. If you meant to add all files, use '.' as the files input."
          exit 1
        fi

    - name: Create and push branch
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
        FILES_TO_ADD: ${{ inputs.files }}
        COMMIT_MESSAGE: ${{ inputs.commit-message }}
      run: |
        if [ -z "${{ inputs.branch-postfix }}" ]; then
          BRANCH_NAME="${{ inputs.branch-prefix }}-$(date +%Y%m%d)-${{ github.run_id }}"
        else
          BRANCH_NAME="${{ inputs.branch-prefix }}-${{ inputs.branch-postfix }}"
        fi

        echo "::debug::Creating branch: $BRANCH_NAME"
        git checkout -b "$BRANCH_NAME"

        echo "::debug::Adding files: $FILES_TO_ADD"
        git add $FILES_TO_ADD

        echo "::debug::Committing changes with message: '$COMMIT_MESSAGE'"
        git commit -m "$COMMIT_MESSAGE"

        echo "::debug::Pushing branch $BRANCH_NAME to origin"
        git push --force origin "$BRANCH_NAME"

        # Set branch name for next step
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

    - name: Create Pull Request
      id: create_pr
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
        PR_TITLE: ${{ inputs.pr-title }}
        PR_BODY: ${{ inputs.pr-body }}
        BASE_BRANCH: ${{ inputs.base-branch }}
      run: |
        echo "::debug::Creating pull request from $BRANCH_NAME to $BASE_BRANCH"
        PR_URL=$(gh pr create \
          --title "$PR_TITLE" \
          --body "$PR_BODY" \
          --head "$BRANCH_NAME" \
          --base "$BASE_BRANCH")

        echo "::debug::Pull request created at: $PR_URL"

        PR_NUMBER=$(gh pr view "$PR_URL" --json number --jq .number)
        echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
