name: 'Create Pull Request'

description: 'Create PR with dependency updates'

inputs:
  token:
    required: true
    type: string
    description: 'GitHub token'

  base-branch:
    required: true
    type: string
    description: 'Base branch for PR'

  branch-prefix:
    required: true
    type: string
    description: 'Prefix for new branch'

  files:
    required: true
    type: string
    description: 'Files to commit'

  commit-message:
    required: true
    type: string
    description: 'Message the commit will have'

  pr-title:
    required: true
    type: string
    description: 'Title of the pull request'

  pr-body:
    required: true
    type: string
    description: 'The Markdown-supported body for the Github pull request'

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        if [ -z "${{ inputs.files }}" ] || [ "${{ inputs.files }}" = "" ]; then
          echo "::error::The 'files' input cannot be empty. It represents files to add with 'git add'. If you meant to add all files, use '.' as the files input."
          exit 1
        fi

    - name: Create and push branch
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
      run: |
        BRANCH_NAME="${{ inputs.branch-prefix }}-$(date +%Y%m%d)-${{ github.run_id }}"

        echo "::debug::Creating branch: $BRANCH_NAME"
        git checkout -b "$BRANCH_NAME"

        echo "::debug::Adding files: ${{ inputs.files }}"
        git add ${{ inputs.files }}

        echo "::debug::Committing changes with message: '${{ inputs.commit-message }}'"
        git commit -m "${{ inputs.commit-message }}"

        echo "::debug::Pushing branch $BRANCH_NAME to origin"
        git push --force origin "$BRANCH_NAME"

        # Set branch name for next step
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

    - name: Create Pull Request
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.token }}
      run: |
        echo "::debug::Creating pull request from $BRANCH_NAME to ${{ inputs.base-branch }}"
        gh pr create \
          --title "${{ inputs.pr-title }}" \
          --body "${{ inputs.pr-body }}" \
          --head "$BRANCH_NAME" \
          --base "${{ inputs.base-branch }}"
