name: 'Semantic Release'

description: 'Run semantic-release with caching and optional backmerge support'

inputs:
  token:
    required: true
    description: 'GitHub token for authentication'
    default: ${{ github.token }}

  enable-backmerge:
    required: false
    description: 'Enable backmerge from main to develop after release'
    default: 'false'

  backmerge-target-branch:
    required: false
    description: 'Target branch for backmerge (only used when enable-backmerge is true)'
    default: 'develop'

  source-branch:
    required: false
    description: 'Source branch for semantic-release (typically main)'
    default: 'main'

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        fetch-tags: true
        token: ${{ inputs.token }}

    - name: Cache semantic-release
      id: cache-sr
      uses: actions/cache@v4
      with:
        path: ~/.npm-global
        key: "npm-sr-${{ runner.os }}-${{ hashFiles('*releaserc*', '**/package-lock.json', '**/package.json') }}"
        restore-keys: |
          npm-sr-${{ runner.os }}-

    - name: Install semantic-release and plugins
      if: steps.cache-sr.outputs.cache-hit != 'true'
      shell: bash
      run: |
        npm config set prefix ~/.npm-global

        # Extract plugin names from .releaserc
        PLUGINS=$(jq -r '.plugins[] | if type == "string" then . else .[0] end' .releaserc* 2>/dev/null || echo "")

        # Build the npm install command with semantic-release and all plugins
        INSTALL_CMD="npm install -g semantic-release"
        if [ -n "$PLUGINS" ]; then
          while IFS= read -r plugin; do
            INSTALL_CMD="$INSTALL_CMD $plugin"
          done <<< "$PLUGINS"
        fi

        # Execute the install command
        eval "$INSTALL_CMD"

    - name: Add ~/.npm-global/bin to PATH
      shell: bash
      run: echo "~/.npm-global/bin" >> $GITHUB_PATH

    - name: Run semantic-release
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      run: semantic-release

    - name: Backmerge to develop
      if: inputs.enable-backmerge == 'true' && github.ref == format('refs/heads/{0}', inputs.source-branch)
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git fetch origin ${{ inputs.backmerge-target-branch }}
        git checkout ${{ inputs.backmerge-target-branch }}
        git merge ${{ inputs.source-branch }} --no-ff -m "chore: backmerge ${{ inputs.source-branch }} after release"
        git push origin ${{ inputs.backmerge-target-branch }}
